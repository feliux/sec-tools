#!/bin/bash

# Script para control de conexiones en VM NAT

# VARIABLES
RED_INTERNA=192.168.14.0/24  # segemento red LAN
PUERTA_ENLACE=192.168.14.1   # puerta de enlace de la red LAN Segment
INTERFAZ_INTERNO=enp0s8      # nombre del interfaz LAN Segment
INTERFAZ_EXTERNO=enp0s3      # nombre del interfaz NAT
PUERTO_BURP=8080             # puerto BURP

# Si no viene parametros, se informa de la sintaxis
if [ $# = 0 ]
then
PARAMETRO="status"
else
PARAMETRO=$1
fi

echo "Accion:" $PARAMETRO
  
# Se analiza el comando
case $PARAMETRO in
  open)
    echo "Se abre el firewall a todas las conexiones"
    echo "Se mata el proceso de DNS (dnsmasq)"
    ps -ef | grep dnsmasq | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se mata el proceso de fakedns"
    ps -ef | grep fakedns | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se para el demonio de resolucion DNS local"
    systemctl stop systemd-resolved
    echo "Se para el servicio de SSH"
    systemctl stop ssh
    echo "Se eliminan todas las cadenas del firewall"
    iptables -F
    iptables -X
    iptables -t nat -F
    iptables -t nat -X
    iptables -t mangle -F
    iptables -t mangle -X
    iptables -t raw -F
    iptables -t raw -X
    iptables -t security -F
    iptables -t security -X
    echo "Se ponen los contadores a cero"
    iptables -Z
    echo "Se establecen políticas por defecto: INPUT = DROP"
    iptables -P INPUT DROP
    echo "Se establecen políticas por defecto: OUTPUT = DROP"
    iptables -P OUTPUT DROP
    echo "Se establecen políticas por defecto: FORWARD = DROP"
    iptables -P FORWARD DROP
    echo "Se permite el trafico local"
    iptables -A OUTPUT -o lo -j ACCEPT
    iptables -A INPUT -i lo -j ACCEPT
    echo "Se permite el trafico de salida por la red externa"
    iptables -A OUTPUT -o $INTERFAZ_EXTERNO -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
    iptables -A INPUT -i $INTERFAZ_EXTERNO -m state --state ESTABLISHED,RELATED -j ACCEPT
    echo "Se permite el trafico en red interna"
    iptables -A OUTPUT -o $INTERFAZ_INTERNO -j ACCEPT
    iptables -A INPUT -i $INTERFAZ_INTERNO -j ACCEPT
    echo "Se permite el trafico de salida de la red interna"
    iptables -t filter -A FORWARD --in-interface $INTERFAZ_INTERNO --out-interface $INTERFAZ_EXTERNO --source $RED_INTERNA -j ACCEPT
    echo "Se permite el trafico de entrada"
    iptables -t filter -A FORWARD --in-interface $INTERFAZ_EXTERNO --out-interface $INTERFAZ_INTERNO --destination $RED_INTERNA -j ACCEPT
    echo "Se hace NAT de las comunicaciones"
    iptables -t nat -A POSTROUTING -o $INTERFAZ_EXTERNO -j MASQUERADE
    echo "Se habilita el DNS (dnsmasq)"
    dnsmasq
    echo "Se permite la redireccion"
    echo 1 > /proc/sys/net/ipv4/ip_forward
    ;;
  close)
    echo "Se cierra el firewall a todas las conexiones"
    echo "Se mata el proceso de DNS (dnsmasq)"
    ps -ef | grep dnsmasq | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se mata el proceso de fakedns"
    ps -ef | grep fakedns | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se para el demonio de resolucion DNS local"
    systemctl stop systemd-resolved
    echo "Se para el servicio de SSH"
    systemctl stop ssh
    echo "Se eliminan todas las cadenas del firewall"
    iptables -F
    iptables -X
    iptables -t nat -F
    iptables -t nat -X
    iptables -t mangle -F
    iptables -t mangle -X
    iptables -t raw -F
    iptables -t raw -X
    iptables -t security -F
    iptables -t security -X
    echo "Se ponen los contadores a cero"
    iptables -Z
    echo "Se establecen políticas por defecto: INPUT = DROP"
    iptables -P INPUT DROP
    echo "Se establecen políticas por defecto: OUTPUT = DROP"
    iptables -P OUTPUT DROP
    echo "Se establecen políticas por defecto: FORWARD = DROP"
    iptables -P FORWARD DROP
    echo "Se permite el trafico local"
    iptables -A OUTPUT -o lo -j ACCEPT
    iptables -A INPUT -i lo -j ACCEPT
    echo "Se permite el trafico de salida por la red externa"
    iptables -A OUTPUT -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    echo "Se permite ping en la red interna"
    iptables -A OUTPUT -o $INTERFAZ_INTERNO -p icmp --icmp-type echo-reply -j ACCEPT
    iptables -A INPUT -i $INTERFAZ_INTERNO -p icmp --icmp-type echo-request -j ACCEPT
    echo "Se activa el demonio de resolucion DNS local"
    systemctl start systemd-resolved
    echo "Se impide la redireccion"
    echo 0 > /proc/sys/net/ipv4/ip_forward
    ;;
  burp)
    echo "Se abre el firewall a todas las conexiones"
    echo "Se mata el proceso de DNS (dnsmasq)"
    ps -ef | grep dnsmasq | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se mata el proceso de fakedns"
    ps -ef | grep fakedns | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se para el demonio de resolucion DNS local"
    systemctl stop systemd-resolved
    echo "Se para el servicio de SSH"
    systemctl stop ssh
    echo "Se eliminan todas las cadenas del firewall"
    iptables -F
    iptables -X
    iptables -t nat -F
    iptables -t nat -X
    iptables -t mangle -F
    iptables -t mangle -X
    iptables -t raw -F
    iptables -t raw -X
    iptables -t security -F
    iptables -t security -X
    echo "Se ponen los contadores a cero"
    iptables -Z
    echo "Se establecen políticas por defecto: INPUT = DROP"
    iptables -P INPUT DROP
    echo "Se establecen políticas por defecto: OUTPUT = DROP"
    iptables -P OUTPUT DROP
    echo "Se establecen políticas por defecto: FORWARD = DROP"
    iptables -P FORWARD DROP
    echo "Se permite el trafico local"
    iptables -A OUTPUT -o lo -j ACCEPT
    iptables -A INPUT -i lo -j ACCEPT
    echo "Se permite el trafico de salida por la red externa"
    iptables -A OUTPUT -o $INTERFAZ_EXTERNO -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
    iptables -A INPUT -i $INTERFAZ_EXTERNO -m state --state ESTABLISHED,RELATED -j ACCEPT
    echo "Se permite el trafico en red interna"
    iptables -A OUTPUT -o $INTERFAZ_INTERNO -j ACCEPT
    iptables -A INPUT -i $INTERFAZ_INTERNO -j ACCEPT
    echo "Se permite el trafico de salida de la red interna"
    iptables -t filter -A FORWARD --in-interface $INTERFAZ_INTERNO --out-interface $INTERFAZ_EXTERNO --source $RED_INTERNA -j ACCEPT
    echo "Se permite el trafico de entrada"
    iptables -t filter -A FORWARD --in-interface $INTERFAZ_EXTERNO --out-interface $INTERFAZ_INTERNO --destination $RED_INTERNA -j ACCEPT
    echo "Se hace NAT de las comunicaciones"
    iptables -t nat -A POSTROUTING -o $INTERFAZ_EXTERNO -j MASQUERADE
    echo "Se redirige todo el tráfico menos DNS al Burp"
    iptables -t nat -A PREROUTING -i $INTERFAZ_INTERNO -p tcp -m tcp -m multiport ! --dports 53 -j DNAT --to-destination $PUERTA_ENLACE:$PUERTO_BURP
    iptables -t nat -A PREROUTING -i $INTERFAZ_INTERNO -p udp -m udp -m multiport ! --dports 53 -j DNAT --to-destination $PUERTA_ENLACE:$PUERTO_BURP
    echo "Se habilita el DNS (dnsmasq)"
    dnsmasq
    echo "Se permite la redireccion"
    echo 1 > /proc/sys/net/ipv4/ip_forward
    ;;
  ssh)
    echo "Se añaden las reglas de acceso a SSH"
    iptables -A INPUT -i $INTERFAZ_INTERNO -p tcp --dport 22 -j ACCEPT
    iptables -A OUTPUT -o $INTERFAZ_INTERNO -p tcp --sport 22 -j ACCEPT
    iptables -A INPUT -i $INTERFAZ_EXTERNO -p tcp --dport 22 -j ACCEPT
    iptables -A OUTPUT -o $INTERFAZ_EXTERNO -p tcp --sport 22 -j ACCEPT
    echo "Se arranca el servicio de SSH"
    systemctl start ssh
    ;;
  ssh-down)
    echo "Se para el servicio de SSH"
    systemctl stop ssh
    echo "Se eliminan las reglas de acceso a SSH"
    iptables -D INPUT -i $INTERFAZ_INTERNO -p tcp --dport 22 -j ACCEPT
    iptables -D OUTPUT -o $INTERFAZ_INTERNO -p tcp --sport 22 -j ACCEPT
    iptables -D INPUT -i $INTERFAZ_EXTERNO -p tcp --dport 22 -j ACCEPT
    iptables -D OUTPUT -o $INTERFAZ_EXTERNO -p tcp --sport 22 -j ACCEPT
    ;;
  dns)
    echo "Se para el demonio de resolucion DNS local"
    systemctl stop systemd-resolved
    echo "Se mata el proceso de DNS (dnsmasq)"
    ps -ef | grep dnsmasq | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se mata el proceso de fakedns"
    ps -ef | grep fakedns | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    iptables -A INPUT -i $INTERFAZ_INTERNO -p udp --dport 53 -j ACCEPT
    iptables -A OUTPUT -o $INTERFAZ_INTERNO -p udp --sport 53 -j ACCEPT
    echo "Se arranca el servicio de fakedns"
    fakedns -I $PUERTA_ENLACE &> /devnull &
    echo "Se activa el demonio de resolucion DNS local"
    systemctl start systemd-resolved
    ;;
  dns-down)
    echo "Se para el demonio de resolucion DNS local"
    systemctl stop systemd-resolved
    echo "Se mata el proceso de DNS (dnsmasq)"
    ps -ef | grep dnsmasq | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    echo "Se mata el proceso de fakedns"
    ps -ef | grep fakedns | grep -v grep | kill $(awk '{print $2}') &> /dev/null
    iptables -D INPUT -i $INTERFAZ_INTERNO -p udp --dport 53 -j ACCEPT
    iptables -D OUTPUT -o $INTERFAZ_INTERNO -p udp --sport 53 -j ACCEPT
    echo "Se activa el demonio de resolucion DNS local"
    systemctl start systemd-resolved
    ;;
  status)
    clear
    echo "************* GENERAL ***************" 
    echo "El estado del firewall es..."
    iptables -v -L -n
    echo "*************** NAT *****************" 
    echo "El estado del NAT del firewall es..."
    iptables -v -L -n -t nat
    echo "************* PUERTOS ***************" 
    echo "Los puertos a la escucha son..."
    netstat -plunt
    ;;
  help)
    echo "Sintaxis: $0 [open|close|burp|ssh|ssh-down|dns|dns-down|status|help]"
    ;;
  *)
    echo "Error: el parametro '"$1"' no es valido"
    echo "Sintaxis: $0 [open|close|burp|ssh|ssh-down|dns|dns-down|status|help]"
    exit 1
    ;;
esac
